<div class="d-flex gap-2">
    <!-- Кнопка "В корзину" -->
    {% if user.is_authenticated %}
        <a href="{% url 'orders:add_to_cart' product.id %}"
        class="btn"
        style="background-color: #1f3d12; color: white; flex: 1;">
            В корзину
        </a>
    {% else %}
        <button disabled class="btn" ...>Войдите чтобы купить</button>
    {% endif %}

    <!-- Кнопка "Подробнее" -->
    <a href="{% url 'product_detail' product.id %}"
       class="btn"
       style="border: 2px solid #3d6b2a; color: #3d6b2a; flex: 1;">
        Подробнее
    </a>

    <!-- Блок с избранным -->
    {% if user.is_authenticated %}
        <form action="{% url 'add_to_favorites' product.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit"
                    class="favorite-btn {% if product in request.user.favorites.all %}active{% endif %}"
                    title="{% if product in request.user.favorites.all %}Удалить из избранного{% else %}Добавить в избранное{% endif %}"
                    style="
                        border: 1px solid transparent !important;
                        background: transparent !important;
                        padding: 0;
                    ">
                <i class="bi bi-heart{% if product in request.user.favorites.all %}-fill{% endif %}"
                   style="border: 1px solid transparent !important;"></i>
            </button>
        </form>
    {% endif %}
</div>

<script>
document.querySelectorAll('.favorite-btn').forEach(button => {
    button.addEventListener('click', async function(e) {
        e.preventDefault(); // Предотвращаем действие по умолчанию
        const form = this.closest('form');

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            if (response.ok) {
                const isActive = this.classList.contains('active');
                const icon = this.querySelector('i');

                // Переключаем классы
                this.classList.toggle('active');
                icon.classList.toggle('bi-heart');
                icon.classList.toggle('bi-heart-fill');

                // Обновляем подсказку
                this.title = isActive ? 'Добавить в избранное' : 'Удалить из избранного';

                // Запускаем анимацию
                icon.style.animation = 'heartBeat 600ms ease-in-out';
                setTimeout(() => {
                    icon.style.animation = '';
                }, 600);
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    });
});
</script>